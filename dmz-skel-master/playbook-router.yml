---
- hosts: all
  become: true
  tasks:
    - name: update apt
      apt: update_cache=yes

    - name: install depends
      apt:
        name: "{{ packages }}"
      vars:
        packages:
        - iptables
        - iptables-persistent
        - dnsmasq
        - squid

    - sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        sysctl_set: yes
        state: present
        reload: yes

    - name: iptables rules
      notify: reload iptables
      copy:
        dest: /etc/iptables/rules.v4
        src: iptables-rules
        
    - name: dnsmasq config
      notify: dsnmasq handler
      copy:
        dest: /etc/dnsmasq.conf
        src: dnsmasq.conf

    - name: hosts config
      notify: dsnmasq handler
      copy:
        dest: /etc/hosts
        src: hosts
   
    - name: squid config
      notify: restart squid
      copy:
        dest: /etc/squid
        src: squid.conf

    - name: proxy
      shell: export http_proxy="http://192.168.1.150:3128/"
      
      
  handlers:
    - name: reload iptables
      command: "iptables-restore /etc/iptables/rules.v4"
      
    - name: dsnmasq handler
      command: "systemctl restart dnsmasq.service"
    
    - name: restart squid
      command: "systemctl restart squid"

